\setlength{\tabcolsep}{2pt}
\renewcommand{\arraystretch}{1.5}
\fontsize{8}{10}

\begin{longtable}{@{}p{5.1cm}{% for group, subcols in headers.items() %}{% for _ in subcols %}c{% endfor %}{% endfor %}}
    \toprule
    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{c}{\large{ {{ title }} SWE Report for {{ date[4:6]|int }}/{{ date[6:8]|int }}/{{ date[0:4] }} }} \\
    \specialrule{0.3pt}{0pt}{0pt}
    {% for group, subcols in headers.items() %}
        & \multicolumn{ {{ subcols|length }} }{c}{ {{ group | replace('%', '\\%') }} }
    {% endfor %} \\
    {% if headers["% of Average"]|length == 2 %}
        \cmidrule(lr){2-3} % % of Average
        \cmidrule(lr){4-5} % SWE (in)
        \cmidrule(lr){9-10} % Pillows
        \cmidrule(lr){11-11} %
    {% else %}
        \cmidrule(lr){2-2} % % of Average
        \cmidrule(lr){3-3} % SWE (in)
        \cmidrule(lr){7-7} % Pillows
        \cmidrule(lr){8-8} % Surveys
        \cmidrule(lr){9-9} % SNODAS
    {% endif %}
    \makecell[l]{Basin}
    {% for i, group in headers.items() %}
        {% for sub in group %}
            & {{ sub | replace('%', '\\%') }}
        {% endfor %}
    {% endfor %} \\
    \midrule
    \endfirsthead

    \toprule
    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{c}{\large{ {{ title }} SWE Report for {{ date[4:6]|int }}/{{ date[6:8]|int }}/{{ date[0:4] }} }} \\
    \specialrule{0.3pt}{0pt}{0pt}
    {% for group, subcols in headers.items() %}
        & \multicolumn{ {{ subcols|length }} }{c}{ {{ group | replace('%', '\\%') }} }
    {% endfor %} \\
    {% if headers["% of Average"]|length == 2 %}
        \cmidrule(lr){2-3} % % of Average
        \cmidrule(lr){4-5} % SWE (in)
        \cmidrule(lr){9-10} % Pillows
        \cmidrule(lr){11-11} %
    {% else %}
        \cmidrule(lr){2-2} % % of Average
        \cmidrule(lr){3-3} % SWE (in)
        \cmidrule(lr){7-7} % Pillows
        \cmidrule(lr){8-8} % Surveys
        \cmidrule(lr){9-9} % SNODAS
    {% endif %}
    \makecell[l]{Basin}
    {% for i, group in headers.items() %}
        {% for sub in group %}
            & {{ sub | replace('%', '\\%') }}
        {% endfor %}
    {% endfor %} \\
    \midrule
    \endhead

    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{l}{
        \footnotesize $\ddagger$ Basin boundaries were derived from a combination of NRCS and HUC8 boundaries.%
    } \\[-6pt]
    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{l}{
        \footnotesize* This is a comparison to the SNODAS (SNOw Data Assimilation System) nationwide product from the National Weather Service.%
    } \\[-6pt]
    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{p{0.95\textwidth}}{
        \footnotesize** The Animas Basin is part of the San Juan Basin. The values present in the San Juan Basin include those of the Animas by either a summation or weighted average based on the area that is referenced in the table.%
    } \\
%     \multicolumn{ {{ 1 + df.shape[1]-1 }} }{p{0.95\textwidth}}{
%         \footnotesize $\ddagger$ For volume totals above Shasta Lake add Upper Sac, McCloud and Pit volumes. For volume totals above Bend Bridge add Upper Sac, McCloud, Pit and Sac at Bend Bridge volumes.%
%     } \\
    \bottomrule
    \endfoot

    \bottomrule
    \endlastfoot

    {% for row in df.iloc[1:].itertuples(index=False) %}
        {% set text = row[0] | replace('%', '\\%') | replace('_', '\\_') %}
        {% if text|length > 30 %}
            {% set mid = (text|length // 2) %}
            {% set split_idx = (
                (text.rfind('-', 0, mid) if text.rfind('-', 0, mid) != -1 else
                 text.rfind('\\_', 0, mid) if text.rfind('\\_', 0, mid) != -1 else
                 mid)
            ) %}
            \makecell[l]{ {{ text[:split_idx+1] }} \\ {{ text[split_idx+1:] }} \vspace*{0.5em} }
        {% else %}
            \makecell[l]{ {{ text }} }
        {% endif %}
        {% for val in row[1:] %}
            & {{ ("NA" if (val != val) else val) | replace('%', '\\%') }}
        {% endfor %} \\
        \specialrule{0.1pt}{4pt}{4pt}
    {% endfor %}
    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{l}{
        \footnotesize $\ddagger$ Basin boundaries were derived from a combination of NRCS and HUC8 boundaries.%
    } \\[-6pt]
    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{l}{
        \footnotesize* This is a comparison to the SNODAS (SNOw Data Assimilation System) nationwide product from the National Weather Service.
    } \\[-6pt]
    \multicolumn{ {{ 1 + df.shape[1]-1 }} }{p{0.95\textwidth}}{
        \footnotesize** The Animas Basin is part of the San Juan Basin. The values present in the San Juan Basin include those of the Animas by either a summation or weighted average based on the area that is referenced in the table.%
    } \\
%     \multicolumn{ {{ 1 + df.shape[1]-1 }} }{p{0.95\textwidth}}{
%         \footnotesize $\ddagger$ For volume totals above Shasta Lake add Upper Sac, McCloud and Pit volumes. For volume totals above Bend Bridge add Upper Sac, McCloud, Pit and Sac at Bend Bridge volumes.%
%     } \\
    {% if aso_corrected %}
        \multicolumn{ {{ 1 + df.shape[1]-1 }} }{l}{\footnotesize*This is a comparison to the SNODAS (SNOw Data Assimilation System) nationwide product from the National Weather Service.} \\
    {% endif %}
\end{longtable}
